name: Build Cross-Platform Libraries

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:


permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Create cl wrapper script to filter incompatible flags
      run: |
        $wrapper = @"
        @echo off
        setlocal enabledelayedexpansion
        set args=
        :parse
        if "%~1"=="" goto execute
        set arg=%~1
        REM Check if arg starts with GCC-specific flags
        set skip=0
        echo !arg! | findstr /B /C:"-W" /C:"-l" /C:"-L" /C:"-g" /C:"-O" /C:"-pthread" /C:"-fPIC" /C:"-march" /C:"-m64" /C:"-m32" >nul
        if not errorlevel 1 set skip=1
        if !skip! equ 0 (
          set args=!args! %~1
        )
        shift
        goto parse
        :execute
        cl.exe !args!
        "@
        $wrapper | Out-File -FilePath "$PWD\cl_wrapper.bat" -Encoding ASCII
        Write-Host "Wrapper script created at: $PWD\cl_wrapper.bat"
      shell: powershell

    - name: Build Windows static library with MSVC
      env:
        CGO_ENABLED: "1"
        CC: "${{ github.workspace }}\\cl_wrapper.bat"
      run: |
        go build -o hello_windows_amd64.lib -buildmode=c-archive main.go
      shell: cmd

    - name: List generated files
      run: dir
      shell: cmd

    - name: Rename header file
      run: |
        if exist hello_windows_amd64.h ren hello_windows_amd64.h hello.h
      shell: cmd

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-library-amd64
        path: |
          hello_windows_amd64.lib
          hello.h

  build-macos-arm64:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Build macOS static library for arm64
      env:
        CGO_ENABLED: "1"
      run: |
        go build -o libhello_macos_arm64.a -buildmode=c-archive main.go

    - name: Rename header file
      run: |
        mv libhello_macos_arm64.h libhello.h

    - name: List output files
      run: ls -la

    - name: Upload macOS arm64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-library-arm64
        path: |
          libhello_macos_arm64.a
          libhello.h

  build-macos-amd64:
    runs-on: macos-13
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Build macOS static library for amd64
      env:
        CGO_ENABLED: "1"
      run: |
        go build -o libhello_macos_amd64.a -buildmode=c-archive main.go

    - name: Rename header file
      run: |
        mv libhello_macos_amd64.h libhello.h

    - name: List output files
      run: ls -la

    - name: Upload macOS amd64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-library-amd64
        path: |
          libhello_macos_amd64.a
          libhello.h

  create-release:
    needs: [ build-windows, build-macos-arm64, build-macos-amd64 ]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
    - name: Download Windows amd64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-library-amd64
        path: ./artifacts/windows-amd64

    - name: Download macOS arm64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: macos-library-arm64
        path: ./artifacts/macos-arm64

    - name: Download macOS amd64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: macos-library-amd64
        path: ./artifacts/macos-amd64

    - name: List downloaded files
      run: |
        echo "Windows amd64:"
        ls -la artifacts/windows-amd64/
        echo "macOS arm64:"
        ls -la artifacts/macos-arm64/
        echo "macOS amd64:"
        ls -la artifacts/macos-amd64/

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ github.run_number }}
        name: Build ${{ github.run_number }}
        files: |
          artifacts/windows-amd64/hello_windows_amd64.lib
          artifacts/windows-amd64/hello.h
          artifacts/macos-arm64/libhello_macos_arm64.a
          artifacts/macos-amd64/libhello_macos_amd64.a
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
