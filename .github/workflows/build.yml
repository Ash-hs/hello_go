name: Build Cross-Platform Libraries

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:


permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Install MinGW-w64
      run: choco install mingw -y
      shell: powershell

    - name: Build Windows DLL with MinGW
      env:
        CGO_ENABLED: "1"
      run: |
        $env:Path = "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin;" + $env:Path
        go build -o hello_windows_amd64.dll -buildmode=c-shared main.go
      shell: powershell

    - name: Generate .lib import library from DLL
      run: |
        $env:Path = "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin;" + $env:Path
        gendef hello_windows_amd64.dll
        dlltool -D hello_windows_amd64.dll -d hello_windows_amd64.def -l hello_windows_amd64.lib
      shell: powershell

    - name: List generated files
      run: dir
      shell: cmd

    - name: Rename header file
      run: |
        if exist hello_windows_amd64.h ren hello_windows_amd64.h hello.h
      shell: cmd

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-library-amd64
        path: |
          hello_windows_amd64.dll
          hello_windows_amd64.lib
          hello.h

  build-windows-clang:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Install LLVM (clang-cl)
      run: choco install llvm -y
      shell: powershell

    - name: Build Windows DLL with clang-cl
      env:
        CGO_ENABLED: "1"
        CC: "clang-cl"
        CXX: "clang-cl"
      run: |
        $env:Path = "C:\Program Files\LLVM\bin;" + $env:Path
        go build -o hello_windows_clang_amd64.dll -buildmode=c-shared main.go
      shell: powershell

    - name: Generate .lib import library using llvm-dlltool
      run: |
        $env:Path = "C:\Program Files\LLVM\bin;" + $env:Path
        llvm-dlltool -m i386:x86-64 -D hello_windows_clang_amd64.dll -l hello_windows_clang_amd64.lib
      shell: powershell

    - name: List generated files
      run: dir
      shell: cmd

    - name: Rename header file
      run: |
        if exist hello_windows_clang_amd64.h ren hello_windows_clang_amd64.h hello_clang.h
      shell: cmd

    - name: Upload Windows clang-cl artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-library-clang-amd64
        path: |
          hello_windows_clang_amd64.dll
          hello_windows_clang_amd64.lib
          hello_clang.h

  build-macos-arm64:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Build macOS static library for arm64
      env:
        CGO_ENABLED: "1"
      run: |
        go build -o libhello_macos_arm64.a -buildmode=c-archive main.go

    - name: Rename header file
      run: |
        mv libhello_macos_arm64.h libhello.h

    - name: List output files
      run: ls -la

    - name: Upload macOS arm64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-library-arm64
        path: |
          libhello_macos_arm64.a
          libhello.h

  build-macos-amd64:
    runs-on: macos-13
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Build macOS static library for amd64
      env:
        CGO_ENABLED: "1"
      run: |
        go build -o libhello_macos_amd64.a -buildmode=c-archive main.go

    - name: Rename header file
      run: |
        mv libhello_macos_amd64.h libhello.h

    - name: List output files
      run: ls -la

    - name: Upload macOS amd64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-library-amd64
        path: |
          libhello_macos_amd64.a
          libhello.h

  create-release:
    needs: [ build-windows, build-windows-clang, build-macos-arm64, build-macos-amd64 ]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
    - name: Download Windows amd64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-library-amd64
        path: ./artifacts/windows-amd64

    - name: Download Windows clang-cl amd64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-library-clang-amd64
        path: ./artifacts/windows-clang-amd64

    - name: Download macOS arm64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: macos-library-arm64
        path: ./artifacts/macos-arm64

    - name: Download macOS amd64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: macos-library-amd64
        path: ./artifacts/macos-amd64

    - name: List downloaded files
      run: |
        echo "Windows amd64:"
        ls -la artifacts/windows-amd64/
        echo "Windows clang-cl amd64:"
        ls -la artifacts/windows-clang-amd64/
        echo "macOS arm64:"
        ls -la artifacts/macos-arm64/
        echo "macOS amd64:"
        ls -la artifacts/macos-amd64/

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ github.run_number }}
        name: Build ${{ github.run_number }}
        files: |
          artifacts/windows-amd64/hello_windows_amd64.dll
          artifacts/windows-amd64/hello_windows_amd64.lib
          artifacts/windows-amd64/hello.h
          artifacts/windows-clang-amd64/hello_windows_clang_amd64.dll
          artifacts/windows-clang-amd64/hello_windows_clang_amd64.lib
          artifacts/windows-clang-amd64/hello_clang.h
          artifacts/macos-arm64/libhello_macos_arm64.a
          artifacts/macos-amd64/libhello_macos_amd64.a
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
