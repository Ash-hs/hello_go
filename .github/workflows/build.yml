name: Build Cross-Platform Libraries

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:


permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Build Windows DLL
      run: |
        go build -o libhello_windows_amd64.dll -buildmode=c-shared main.go
      shell: cmd

    - name: Rename files
      run: |
        ren liblibhello_windows_amd64.a libhello_windows_amd64.lib
        ren libhello_windows_amd64.h libhello.h
      shell: cmd
      continue-on-error: true

    - name: List output files
      run: dir
      shell: cmd

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-library-amd64
        path: |
          libhello_windows_amd64.dll
          libhello_windows_amd64.lib
          libhello.h

  build-macos-arm64:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Build macOS dynamic library for arm64
      run: |
        go build -o libhello_macos_arm64.dylib -buildmode=c-shared main.go

    - name: Build macOS static library for arm64
      run: |
        go build -o libhello_macos_arm64.a -buildmode=c-archive main.go

    - name: Rename header file
      run: |
        mv libhello_macos_arm64.h libhello.h

    - name: List output files
      run: ls -la

    - name: Upload macOS arm64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-library-arm64
        path: |
          libhello_macos_arm64.dylib
          libhello_macos_arm64.a
          libhello.h

  build-macos-amd64:
    runs-on: macos-13
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Build macOS dynamic library for amd64
      run: |
        go build -o libhello_macos_amd64.dylib -buildmode=c-shared main.go

    - name: Build macOS static library for amd64
      run: |
        go build -o libhello_macos_amd64.a -buildmode=c-archive main.go

    - name: Rename header file
      run: |
        mv libhello_macos_amd64.h libhello.h

    - name: List output files
      run: ls -la

    - name: Upload macOS amd64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-library-amd64
        path: |
          libhello_macos_amd64.dylib
          libhello_macos_amd64.a
          libhello.h

  create-release:
    needs: [ build-windows, build-macos-arm64, build-macos-amd64 ]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
    - name: Download Windows amd64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-library-amd64
        path: ./windows-amd64

    - name: Download macOS arm64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: macos-library-arm64
        path: ./macos-arm64

    - name: Download macOS amd64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: macos-library-amd64
        path: ./macos-amd64

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ github.run_number }}
        name: Build ${{ github.run_number }}
        files: |
          windows-amd64/*
          macos-arm64/*
          macos-amd64/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
